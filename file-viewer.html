<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù - Top Pharma</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="js/theme.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="index.html" class="navbar-brand">
                ğŸ’Š <span>Top Pharma</span>
            </a>
            <ul class="navbar-menu">
                <li><a href="dashboard.html" class="navbar-link">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a></li>
                <li><a href="profile.html" class="navbar-link">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a></li>
                <li><a href="videos.html" class="navbar-link">Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</a></li>
                <li><a href="quizzes.html" class="navbar-link">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</a></li>
                <li><a href="files.html" class="navbar-link">Ø§Ù„Ù…Ù„ÙØ§Øª</a></li>
                <li><a href="#" onclick="signOut(); return false;" class="navbar-link btn btn-secondary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
            </ul>
        </div>
    </nav>

    <section class="section">
        <div class="container">
            <a href="files.html" class="btn btn-outline mb-3">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù„ÙØ§Øª</a>

            <div class="content-warning-banner" role="alert">
                <div class="content-warning-title">ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø§Ù†ÙˆÙ†ÙŠ</div>
                <p>
                    Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø­Ù…ÙŠ Ø¨Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù†Ø´Ø± ÙˆÙ…ØªØ§Ø­ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´Ø®ØµÙŠ Ø¯Ø§Ø®Ù„ Ù…Ù†ØµØ© Top Pharma ÙÙ‚Ø·.
                    ÙŠÙÙ…Ù†Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø´Ø§Ø´Ø© Ø£Ùˆ Ø§Ù„Ù†Ø³Ø® Ø£Ùˆ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø´Ø± Ø¨Ø£ÙŠ ÙˆØ³ÙŠÙ„Ø© Ø¯ÙˆÙ† Ø¥Ø°Ù† Ù…Ø³Ø¨Ù‚.
                </p>
            </div>
            <div id="loading"></div>

            <div id="fileViewerContainer" class="file-viewer-container">
                <div id="fileContent" class="file-viewer-content"></div>
            </div>

            <div class="card" style="margin-top: 1.5rem;">
                <h2 id="fileTitle">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù„Ù</h2>
                <div style="display: flex; gap: 1rem; margin: 1rem 0; flex-wrap: wrap;">
                    <span id="fileType" class="category-badge">Ø§Ù„Ù†ÙˆØ¹</span>
                    <span id="fileDate" style="color: var(--gray);">Ø§Ù„ØªØ§Ø±ÙŠØ®</span>
                </div>
                <p id="fileDescription" style="color: var(--gray); line-height: 1.8;">
                    ÙˆØµÙ Ø§Ù„Ù…Ù„Ù
                </p>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/subject-access.js"></script>
    <script src="js/files.js"></script>
    <script src="js/content-protection.js"></script>

    <script>
        (async () => {
            const isAuth = await requireAuth();
            if (!isAuth) return;

            const fileId = getQueryParam('id');
            if (!fileId) {
                showError('Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                setTimeout(() => {
                    window.location.href = 'files.html';
                }, 2000);
                return;
            }

            const user = await getCurrentUser();
            const profile = user ? await getUserProfile(user.id) : null;
            const userName = profile?.full_name || user?.email || '';
            const userPhone = profile?.phone || '';
            enableContentProtection({
                userName,
                userPhone,
                targetId: 'fileViewerContainer'
            });

            const subjectParam = getQueryParam('subject');
            if (subjectParam) {
                const canAccess = await requireSubjectAccess(subjectParam, window.location.href);
                if (!canAccess) return;
            }

            await loadFile(fileId);
        })();

        async function loadFile(fileId) {
            showLoading('loading');
            try {
                const file = await getFileById(fileId);
                if (!file) {
                    showError('Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    setTimeout(() => {
                        window.location.href = 'files.html';
                    }, 2000);
                    return;
                }

                if (file.subject_id) {
                    const canAccess = await requireSubjectAccess(file.subject_id, window.location.href);
                    if (!canAccess) return;
                }

                let fileUrl = getFileDownloadUrl(file.file_url);
                const fileContent = document.getElementById('fileContent');
                const fileType = file.file_type || 'other';

                if (fileUrl.includes('drive.google.com') && !fileUrl.includes('/preview')) {
                    const match = fileUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
                    if (match) {
                        fileUrl = `https://drive.google.com/file/d/${match[1]}/preview`;
                    }
                }

                if (fileType === 'image') {
                    fileContent.innerHTML = `<img src="${fileUrl}" alt="${file.title}" class="file-viewer-image">`;
                } else if (fileType === 'pdf') {
                    const viewerUrl = fileUrl.includes('#') ? fileUrl : `${fileUrl}#toolbar=0&navpanes=0&scrollbar=0`;
                    fileContent.innerHTML = `<iframe class="file-viewer-frame" src="${viewerUrl}"></iframe>`;
                } else {
                    fileContent.innerHTML = `
                        <div class="file-viewer-placeholder">
                            <p>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù…Ø¨Ø§Ø´Ø±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†ØµØ©.</p>
                            <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Ø³Ø®Ø© Ù…Ø®ØµØµØ©.</p>
                        </div>
                    `;
                }

                document.getElementById('fileTitle').textContent = file.title;
                document.getElementById('fileDescription').textContent = file.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ';
                document.getElementById('fileType').textContent = fileType.toUpperCase();
                document.getElementById('fileType').className = 'category-badge';
                document.getElementById('fileDate').textContent = formatDate(file.created_at);
            } catch (error) {
                console.error('Error loading file:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù');
            } finally {
                hideLoading('loading');
            }
        }
    </script>
</body>
</html>
