<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ - Top Pharma</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="js/theme.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="index.html" class="navbar-brand">
                ğŸ’Š <span>Top Pharma</span>
            </a>
            <ul class="navbar-menu">
                <li><a href="dashboard.html" class="navbar-link">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a></li>
                <li><a href="profile.html" class="navbar-link">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a></li>
                <li><a href="videos.html" class="navbar-link">Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</a></li>
                <li><a href="quizzes.html" class="navbar-link">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</a></li>
                <li><a href="files.html" class="navbar-link">Ø§Ù„Ù…Ù„ÙØ§Øª</a></li>
                <li><a href="#" onclick="signOut(); return false;" class="navbar-link btn btn-secondary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
            </ul>
        </div>
    </nav>

    <!-- Video Player Section -->
    <section class="section">
        <div class="container">
            <a href="videos.html" class="btn btn-outline mb-3">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</a>

            <div class="content-warning-banner" role="alert">
                <div class="content-warning-title">ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø§Ù†ÙˆÙ†ÙŠ</div>
                <p>
                    Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø­Ù…ÙŠ Ø¨Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù†Ø´Ø± ÙˆÙ…ØªØ§Ø­ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´Ø®ØµÙŠ Ø¯Ø§Ø®Ù„ Ù…Ù†ØµØ© Top Pharma ÙÙ‚Ø·.
                    ÙŠÙÙ…Ù†Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø´Ø§Ø´Ø© Ø£Ùˆ Ø§Ù„Ù†Ø³Ø® Ø£Ùˆ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø´Ø± Ø¨Ø£ÙŠ ÙˆØ³ÙŠÙ„Ø© Ø¯ÙˆÙ† Ø¥Ø°Ù† Ù…Ø³Ø¨Ù‚.
                </p>
            </div>
            
            <div id="loading"></div>
            
            <div id="videoContainer">
                <div class="video-player-container" id="playerWrapper">
                    <video id="videoPlayer" class="video-player" controls width="100%" style="display: none;">
                        Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                    </video>
                    <iframe id="videoFrame" class="video-player" frameborder="0" allowfullscreen style="display: none;"></iframe>
                </div>
                
                <div class="card" style="margin-top: 1.5rem;">
                    <h2 id="videoTitle">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</h2>
                    <div style="display: flex; gap: 1rem; margin: 1rem 0; flex-wrap: wrap;">
                        <span id="videoCategory" class="category-badge">Ø§Ù„ÙØ¦Ø©</span>
                        <span id="videoDate" style="color: var(--gray);">Ø§Ù„ØªØ§Ø±ÙŠØ®</span>
                    </div>
                    <p id="videoDescription" style="color: var(--gray); line-height: 1.8;">
                        ÙˆØµÙ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                    </p>
                </div>
            </div>
        </div>
    </section>

    <div id="suspiciousOverlay" class="content-suspect-overlay" hidden>
        <div class="content-suspect-card">
            <h2>ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ </h2>
            <p>
                ØªÙ… Ø±ØµØ¯ Ø³Ù„ÙˆÙƒ Ù…ØªÙƒØ±Ø± ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø´Ø§Ø´Ø© Ø£Ùˆ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„.
                Ø­ÙØ§Ø¸Ù‹Ø§ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©ØŒ ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
            </p>
            <p class="content-suspect-note">
             ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
            </p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/subject-access.js"></script>
    <script src="js/videos.js"></script>
    <script src="js/content-protection.js"></script>
    
    <script>
        // Protect page and load video
        (async () => {
            const isAuth = await requireAuth();
            if (!isAuth) return;

            const videoId = getQueryParam('id');
            if (!videoId) {
                showError('Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                setTimeout(() => {
                    window.location.href = 'videos.html';
                }, 2000);
                return;
            }

            const user = await getCurrentUser();
            const profile = user ? await getUserProfile(user.id) : null;
            const userName = profile?.full_name || user?.email || '';
            const userPhone = profile?.phone || '';

            enableContentProtection({
                userName,
                userPhone,
                targetId: 'playerWrapper'
            });

            const suspiciousOverlay = document.getElementById('suspiciousOverlay');
            const detectionThreshold = 3;

            const handleSuspiciousBehavior = () => {
                const videoPlayer = document.getElementById('videoPlayer');
                const videoFrame = document.getElementById('videoFrame');

                if (videoPlayer && !videoPlayer.paused) {
                    videoPlayer.pause();
                }

                if (videoFrame && videoFrame.src) {
                    videoFrame.src = '';
                }

                document.body.classList.add('content-suspect-state');
                if (suspiciousOverlay) {
                    suspiciousOverlay.removeAttribute('hidden');
                }

                if (typeof showToast === 'function') {
                    showToast('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø³Ø¨Ø¨ ØªÙƒØ±Ø§Ø± Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø´ØªØ¨Ù‡ Ø¨Ù‡Ø§', 'error');
                }
            };

            if (typeof enableScreenCaptureDetection === 'function') {
                enableScreenCaptureDetection({
                    threshold: detectionThreshold,
                    onAttempt: ({ attempts, threshold }) => {
                        if (typeof showToast === 'function') {
                            showToast(`ØªÙ… Ø±ØµØ¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø´ØªØ¨Ù‡ Ø¨Ù‡Ø§ (${attempts}/${threshold})`, 'error');
                        }
                    },
                    onThreshold: handleSuspiciousBehavior
                });
            }

            const subjectParam = getQueryParam('subject');
            if (subjectParam) {
                const canAccess = await requireSubjectAccess(subjectParam, window.location.href);
                if (!canAccess) return;
            }
            
            await loadVideo(videoId);
        })();

        async function loadVideo(videoId) {
            showLoading('loading');
            
            try {
                const video = await getVideoById(videoId);
                
                if (!video) {
                    showError('Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    setTimeout(() => {
                        window.location.href = 'videos.html';
                    }, 2000);
                    return;
                }

                if (video.subject_id) {
                    const canAccess = await requireSubjectAccess(video.subject_id, window.location.href);
                    if (!canAccess) return;
                }
                
                // Update video player
                // Update video player
                const videoUrl = getVideoUrl(video.video_url);
                const videoPlayer = document.getElementById('videoPlayer');
                const videoFrame = document.getElementById('videoFrame');

                if (videoUrl.includes('drive.google.com') || videoUrl.includes('youtube.com') || videoUrl.includes('vimeo')) {
                    videoPlayer.style.display = 'none';
                    videoPlayer.pause();
                    videoFrame.src = videoUrl;
                    videoFrame.style.display = 'block';
                } else {
                    videoFrame.style.display = 'none';
                    videoFrame.src = '';
                    applyVideoElementProtection(videoPlayer);
                    videoPlayer.src = videoUrl;
                    videoPlayer.style.display = 'block';
                }
                
                // Update video info
                document.getElementById('videoTitle').textContent = video.title;
                document.getElementById('videoDescription').textContent = video.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ';
                
                const categoryBadge = document.getElementById('videoCategory');
                categoryBadge.textContent = getCategoryName(video.category);
                categoryBadge.className = `category-badge category-${video.category}`;
                
                document.getElementById('videoDate').textContent = formatDate(video.created_at);
                
            } catch (error) {
                console.error('Error loading video:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ');
            } finally {
                hideLoading('loading');
            }
        }
    </script>
</body>
</html>
